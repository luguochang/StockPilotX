# 05 调试与排查手册

## 本地最小验证
```powershell
python -m backend.main
```

## 单测
```powershell
python -m unittest discover -s tests -p "test_*.py" -v
```

## 典型问题

### 1. 返回 `mode=graph_rag` 不符合预期
排查：问题文本是否包含关键词（关系/演化/关联/产业链/股权）。

### 2. 输出缺少引用
排查：`state.evidence_pack` 是否为空；`_build_citations` 是否被执行。

### 3. 模型调用报限额
排查：`BudgetMiddleware` 的 `max_model_calls/max_tool_calls`。

### 4. 风险标记异常
排查：`GuardrailMiddleware.before_agent` 是否命中规则词。

## 建议日志位点
- `before_agent`
- `router`
- `retrieval`
- `analysis`
- `critic`
- `after_agent`

## 推荐阅读顺序（带代码）
1. `backend/app/http_api.py`
2. `backend/app/service.py`
3. `backend/app/agents/workflow.py`
4. `backend/app/middleware/hooks.py`
5. `backend/app/data/sources.py`
