# 02 请求链路与执行时序

以 `POST /v1/query` 为例：

## 时序
1. `http_api.query(payload)`
2. `AShareAgentService.query(payload)`
3. `QueryRequest(**payload)` 做输入校验
4. `TraceStore.new_trace()` 生成 trace_id
5. 构建 `AgentState`
6. `MemoryStore.list_memory()` 读取历史记忆
7. `AgentWorkflow.run(state, memory_hint)`
8. `MemoryStore.add_memory()` 回写本次任务摘要
9. 组装 `QueryResponse` 并返回

## AgentWorkflow 内部六段
1. Router：识别意图 `fact/deep/doc_qa/compare`
2. Data：生成检索计划参数
3. RAG：在 AgenticRAG 和 GraphRAG 之间路由
4. Analysis：统计证据并生成摘要
5. Report：构建 prompt、调模型、加工输出
6. Critic：生成 citations，补充风险标记

## 与 Java 常见实现差异
- Java：常见 Service 内部调用多个 Bean。
- 本项目：把编排集中在 `AgentWorkflow.run()`，更像显式状态机。

## 调试建议
- 先看 `trace_id`
- 再看 `TraceStore.list_events(trace_id)`
- 重点观察 `router`、`retrieval`、`critic` 三个节点
