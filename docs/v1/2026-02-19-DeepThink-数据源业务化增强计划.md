# DeepThink 数据源业务化增强计划（2026-02-19）

## 1. 背景与目标
当前 StockPilotX 已完成多数据源接入（news/research/macro/fund 等），但仍存在“后端接入充分、前端业务价值呈现不足”的问题。  
本计划目标是将数据源能力转化为用户可执行的个股分析结论，形成研究-决策-执行-复盘闭环。

---

## 2. 现状结论（基线）
### 2.1 已完成
- 后端多源摄取与检索轨道接入（news/research/macro/fund）。
- DeepThink 已具备流式输出、轮次会话、业务摘要基础能力。
- 已有数据源管理接口：`/v1/datasources/*` 与 `/v1/ingest/*`。

### 2.2 主要缺口
- 前端仍有部分页面未跟上新接口，存在旧接口引用和展示语义偏工程化。
- 多源数据未统一沉淀成“可执行建议 + 证据绑定 + 失效条件”的业务卡片。
- 用户对 Agent 角色、轮次行为、冲突来源理解成本较高。

---

## 3. 网络对标结论（方向约束）
参考优秀投研/量化产品后，确定以下共性能力必须补齐：
1. 多源融合后的“业务结论卡”，而非字段堆叠。
2. 事件日历（财报/宏观/政策）与风险触发联动。
3. 检索链路采用“两阶段决策”：粗排（BM25+向量）+ 精排（rerank）。
4. 可解释性：每条结论必须可追溯到证据（来源、时间、可靠度）。
5. 量化流程闭环：研究 -> 信号 -> 风控 -> 执行 -> 复盘。

---

## 4. 产品定位决策
- 定位：**专业投研优先**（已确认）
- 交互策略：默认展示业务视图，工程视图折叠隐藏，按需展开。
- 输出风格：强调“为什么现在、为什么不是、下一步做什么”。

---

## 5. 目标架构（业务视角）
### 5.1 核心能力
1. 个股情报卡片（Intel Card）
- 建议动作（buy/hold/reduce）
- 置信度
- 仓位建议
- 关键触发因素
- 风险监控点
- 失效条件
- 复核时间

2. 证据绑定层
- 每条结论绑定 citation：source/time/url/reliability/retrieval_track

3. 事件日历层
- 未来政策窗口、宏观数据发布时间、财报节点

4. 复盘层
- 用户是否采纳建议
- T+1/T+5/T+20 偏差跟踪

### 5.2 A股特化策略
- 牛短熊长语境下默认“快进慢退”节奏模板
- 外部实时情报缺失时自动降置信，不阻断流程
- 分歧扩大 + 风控触发时自动提示信号失效风险

---

## 6. 接口与类型改造计划
### 6.1 新增接口
- `GET /v1/analysis/intel-card?stock_code=...&horizon=...&risk_profile=...`

### 6.2 返回结构（IntelCardResponse）
- stock_code
- overall_signal
- confidence
- risk_level
- position_hint
- key_catalysts[]
- risk_watch[]
- event_calendar[]
- scenario_matrix[]
- evidence[]
- invalidation_conditions[]
- next_review_time
- data_freshness

### 6.3 现有接口增强
- DeepThink 轮次结果补充 `business_explain` 与 `source_contribution`
- 数据源健康接口增加 `used_in_ui_modules[]` / `last_used_at` / `staleness_minutes`

---

## 7. 分轮实施计划（ROUND）
### ROUND-1：可见性与一致性修复
- 修复 ops/health 旧接口引用
- 修复乱码与提示文案
- 输出“数据源 -> 页面模块”覆盖矩阵

### ROUND-2：后端业务映射层
- 实现 intel-card 聚合逻辑
- 统一新闻/研报/资金/宏观到业务字段

### ROUND-3：RAG 两阶段检索
- 粗排：BM25 + 向量（RRF）
- 精排：rerank top-k
- 引用归因校验

### ROUND-4：DeepThink 业务视图重构
- 新增结论卡/证据卡/事件卡/情景矩阵
- 工程视图默认折叠

### ROUND-5：风控与执行建议
- 仓位区间、调仓节奏、失效条件模板
- 异常/降级策略显式展示

### ROUND-6：复盘闭环
- 用户采纳记录
- 结果偏差统计

### ROUND-7：回归与收口
- 全链路回归测试
- 文档、checklist、交接更新

---

## 8. 验收标准
### 功能验收
- 单股分析可输出完整可执行卡片
- 每条结论可追溯证据
- 切换股票后会话隔离正确

### 性能验收
- 核心接口 P95 <= 2.5s（不含外部 websearch 超时）
- 降级模式下主流程可用

### 业务验收
用户能清晰回答：
1. 当前建议是什么？
2. 为什么给出这个建议？
3. 在什么条件下建议失效？

---

## 9. 执行纪律（必须）
每一轮执行完都必须：
1. 自测并记录结果（接口 + 前端链路）
2. 更新 checklist 勾选状态
3. 新增/更新技术文档（关键实现、取舍、风险）
4. 提交 commit（信息完整可追溯）
5. 代码新增注释，保证后续可维护性

---

## 10. 风险与默认策略
- 外部情报不可用：降置信 + 标注 fallback_reason + 保留本地证据结论
- 数据新鲜度不足：标注 stale 并触发复核提示
- 多 Agent 高分歧：自动进入补证重规划并降低动作级别
