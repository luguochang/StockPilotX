# 假流式问题复盘（DeepThink / 高级分析）- 2026-02-15

## 1. 问题现象
- 前端显示“流式中”，但用户体感是长时间无输出，最后一次性看到大量 `answer_delta`。
- Network 中 `content-type: text/event-stream` 正常，但并非真正的增量可见。

## 2. 根因归类

### 2.1 应用层“先收集后发送”
- 症状：后端代码名义上是 `stream`，但内部先把增量事件收集成列表，再统一 `yield`。
- 影响：前端只能在模型结束后一次性收到所有 token，形成“假流式”。
- 本次对应修复：
  - `AgentWorkflow.run_stream` 改为直接消费 `stream_model_iter`，边收边发。

### 2.2 流式首包被前置耗时步骤阻塞
- 症状：数据刷新/检索准备在 `yield start` 之前执行。
- 影响：用户在连接建立后仍长时间无事件，误判为接口卡死。
- 本次对应修复：
  - `/v1/query/stream` 先发 `start`，再执行 refresh；新增 `progress` 阶段事件。

### 2.3 前后端 SSE 解析器不一致
- 症状：不同页面使用不同解析器，部分仅支持 `\n\n` 分隔，不处理 `\r\n\r\n` 与尾包。
- 影响：接口在发事件，前端却不触发渲染更新。
- 本次对应修复：
  - 前端统一使用 `readSSEAndConsume`，兼容 CRLF 与尾包消费。

### 2.4 UI 过滤/状态导致“看起来没流式”
- 症状：事件过滤条件未清空、状态面板仅依赖 `answer_delta`。
- 影响：实际有进度事件，但页面看不到变化。
- 本次对应修复：
  - 执行前清空过滤条件；展示 `progress/model_wait` 阶段文本。

### 2.5 基础设施缓冲与网关行为
- 症状：反向代理或中间层缓冲把小包合并后再下发。
- 影响：到浏览器表现为“批量到达”。
- 现状：本地 header 已配置 `X-Accel-Buffering: no`、`Transfer-Encoding: chunked`，但跨环境仍需按网关逐项核查。

## 3. 为什么这个问题容易反复出现
- “接口是 SSE”被误等同于“用户可见真流式”；忽略了应用层是否增量 `yield`。
- 代码演进中容易把“便于测试的 collect 逻辑”误放到生产主路径。
- 前端多个页面各自维护 SSE 解析逻辑，修一处漏一处。
- 验收指标偏重“功能返回正确”，缺少“首事件时延/增量频率”约束。

## 4. 防复发标准（执行约束）

### 4.1 后端编码约束
- 禁止在实时路径先 `collect` 再 `yield`。
- 对所有 SSE 接口要求：
  - 连接建立后尽快发送 `start`（建议 < 500ms）。
  - 长耗时阶段必须发送 `progress` 心跳（建议 0.8~1.5s）。

### 4.2 前端消费约束
- 强制复用统一 SSE 解析器（支持 `\n\n`、`\r\n\r\n`、尾包）。
- 连接成功但 0 事件应明确报错，禁止静默等待。

### 4.3 测试与验收约束
- 单测：验证 `run_stream` 事件顺序与实时发射逻辑。
- 接口测试：验证 `start/progress` 在首包阶段可达。
- 性能验收：
  - `first_event_p95 < 1.5s`
  - 模型阶段有周期性 `model_wait`/`progress`

### 4.4 运维与网关约束
- 明确记录并校验：
  - `proxy_buffering off` / 等效配置
  - 长连接超时、心跳策略
  - 反向代理是否合并 chunk

## 5. 本轮结论
- 假流式并非单一 bug，而是“执行链路 + 解析链路 + 可观测性 + 网关行为”的系统性问题。
- 本轮已完成核心修复与可视化增强；后续需按防复发标准把“真流式”作为默认验收项，而不是附加体验项。
