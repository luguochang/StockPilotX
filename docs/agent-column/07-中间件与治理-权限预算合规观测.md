# 中间件与治理：权限、预算、合规、观测

日期：2026-02-15

## 1. 中间件在多 Agent 系统里做什么
- 不是“可有可无的拦截器”，而是治理平面。
- 管理四类问题：
  - 安全权限
  - 成本预算
  - 合规风险
  - 可观测性

## 2. 与当前系统映射
- 现有 hook：
  - `before_agent`
  - `before_model`
  - `after_model`
  - `after_agent`
- 代码：`backend/app/middleware/hooks.py`

## 3. 推荐治理链
1. `before_agent`：鉴权、租户、意图风险初筛
2. `before_model`：prompt 注入、变量校验、预算切片
3. `wrap_tool_call`：工具 ACL、参数审计、超时重试
4. `after_model`：结构校验、引用占位检查、敏感词过滤
5. `after_agent`：审计落库、指标上报、trace 绑定

## 4. 权限治理
- agent 级工具白名单（最小权限）。
- 高风险工具必须 HITL 审批。
- 对外 A2A 代理必须单独策略域与配额域。

## 5. 预算治理
- 预算对象：会话、轮次、agent、工具。
- 超限策略：
  - 自动降级模型
  - 自动收敛检索范围
  - 输出“预算触顶，结论保守”

## 6. 合规治理（股票场景）
- 禁止确定性收益承诺。
- 必须输出风险免责声明。
- 关键结论必须给证据链接或证据 ID。

## 7. 观测治理
- 每次调用必须有 trace_id。
- 失败事件必须有 error_code 和失败阶段。
- 可回放一次完整决策轨迹。

